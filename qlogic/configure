#!/bin/bash

VFILES="Core.v Logic.v Cxlight.v Cx2C.v AutoBound.v compiler/CoreCompiler.v"
EXAMPLES="Common.v RecId.v BinSearch.v PLDI.v Quicksort.v Fibonacci.v"
COMPCERT="../qcompcert"

BUILD_EXAMPLES="no"

while [ $# -gt 0 ]; do
    case "$1" in
        "-h"|"-help"|"--help")
            echo "./configure [--examples] [--compcert PATH]"
            echo
            echo "    --examples       Build examples"
            echo "    --compcert PATH  Specify CompCert's source location"
            echo
            exit 0
            ;;
        "--examples")
            BUILD_EXAMPLES="yes"
            ;;
        "--compcert")
            COMPCERT="$2"
            shift
            ;;
        *)
            echo "invalid usage, see ./configure -h" >&2
            exit 1
    esac
    shift
done

cat <<EOF

Configuration:
    CompCert location........... $COMPCERT
    Building examples........... $BUILD_EXAMPLES

If anything above is wrong consult ./configure -h.

EOF

DIRS="compcert/lib compcert/common compcert/ia32/standard \
      compcert/ia32 compcert/backend compcert/cfrontend \
      compcert/driver compcert/flocq/Appli compcert/flocq/Calc \
      compcert/flocq/Core compcert/flocq/Prop compcert/flocq"

[ "$BUILD_EXAMPLES" = "no" ] && EXAMPLES=""

> Makefile.config cat <<EOF
# Generated by configure
# Do not edit by hand!

# Compcert location
COMPCERT = $COMPCERT

# Compcert directories
DIRS = $DIRS

# Coq files which need to be compiled
VFILES = $VFILES

# Example files which need to be compiled
EXAMPLES = $EXAMPLES
EOF

# Create the compcert link.
rm -f ./compcert
ln -sf $COMPCERT ./compcert

# Create necessary directories for the build.
mkdir -p extraction
mkdir -p glob
